{% extends "base.html" %}

{% block title %}ç¼“å­˜ç®¡ç† - PicGate ç®¡ç†åå°{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ç¼“å­˜ç®¡ç†</h1>
    <p>ç®¡ç†æœ¬åœ°å›¾ç‰‡ç¼“å­˜å’Œ R2 ä¸Šä¼ </p>
</div>

<div class="stats-grid" id="statsGrid">
    <div class="stat-card">
        <div class="stat-icon">ğŸ’¾</div>
        <div class="stat-content">
            <div class="stat-value" id="localImages">-</div>
            <div class="stat-label">æœ¬åœ°å›¾ç‰‡</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">ğŸ“¦</div>
        <div class="stat-content">
            <div class="stat-value" id="diskUsage">-</div>
            <div class="stat-label">ç£ç›˜å ç”¨</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">â³</div>
        <div class="stat-content">
            <div class="stat-value" id="pendingUploads">-</div>
            <div class="stat-label">ç­‰å¾…ä¸Šä¼ </div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">âŒ</div>
        <div class="stat-content">
            <div class="stat-value" id="failedUploads">-</div>
            <div class="stat-label">ä¸Šä¼ å¤±è´¥</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>ç¼“å­˜æ“ä½œ</h2>
    </div>
    <div class="card-body">
        <div class="action-buttons">
            <button onclick="triggerCleanup()" class="btn btn-warning">
                ğŸ§¹ æ¸…ç†è¿‡æœŸç¼“å­˜
            </button>
            <button onclick="clearAllLocal()" class="btn btn-danger">
                ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜
            </button>
            <button onclick="uploadPending()" class="btn btn-success">
                â˜ï¸ ä¸Šä¼ åˆ° R2
            </button>
            <button onclick="retryUploads()" class="btn btn-primary">
                ğŸ”„ é‡è¯•å¤±è´¥ä¸Šä¼ 
            </button>
            <button onclick="generateThumbnails()" class="btn btn-info">
                ğŸ–¼ï¸ ç”Ÿæˆç¼©ç•¥å›¾
            </button>
        </div>
        <p class="help-text">
            <strong>æ¸…ç†è¿‡æœŸç¼“å­˜ï¼š</strong> åˆ é™¤è¶…è¿‡ TTL çš„æœ¬åœ°æ–‡ä»¶ã€‚<br>
            <strong>æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜ï¼š</strong> åˆ é™¤æ‰€æœ‰æœ¬åœ°å›¾ç‰‡ï¼ˆä¿ç•™å…ƒæ•°æ®ï¼Œå¯ä» R2 æ¢å¤ï¼‰ã€‚<br>
            <strong>ä¸Šä¼ åˆ° R2ï¼š</strong> å°†å¾…å¤„ç†çš„å›¾ç‰‡ä¸Šä¼ åˆ° R2 å­˜å‚¨ã€‚<br>
            <strong>é‡è¯•å¤±è´¥ä¸Šä¼ ï¼š</strong> é‡æ–°å°è¯•ä¸Šä¼ å¤±è´¥çš„å›¾ç‰‡ã€‚<br>
            <strong>ç”Ÿæˆç¼©ç•¥å›¾ï¼š</strong> ä¸ºæ‰€æœ‰æœ¬åœ°å›¾ç‰‡ç”Ÿæˆé¢„è§ˆç¼©ç•¥å›¾ï¼ŒåŠ å¿«å›¾ç‰‡é¢„è§ˆé¡µé¢åŠ è½½ã€‚
        </p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>ç¼“å­˜ä¿¡æ¯</h2>
    </div>
    <div class="card-body">
        <div class="info-table">
            <div class="info-row">
                <span class="info-label">ç¼“å­˜ TTLï¼š</span>
                <span class="info-value" id="cacheTtl">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">å…ƒæ•°æ®ä¿ç•™æœŸï¼š</span>
                <span class="info-value" id="metadataRetention">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">R2 å·²é…ç½®ï¼š</span>
                <span class="info-value" id="r2Configured">-</span>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>ğŸ“¦ ç¼“å­˜å¤§å°é™åˆ¶</h2>
    </div>
    <div class="card-body">
        <div class="form-group">
            <label for="maxCacheMb">æœ€å¤§æœ¬åœ°ç¼“å­˜å¤§å° (MB)</label>
            <div class="input-group">
                <input type="number" id="maxCacheMb" value="0" min="0" step="100" placeholder="0 = ä¸é™åˆ¶">
                <button onclick="saveMaxCacheSize()" class="btn btn-primary">ä¿å­˜</button>
            </div>
            <small>è®¾ä¸º 0 è¡¨ç¤ºä¸é™åˆ¶ã€‚è¾¾åˆ°é™åˆ¶æ—¶è‡ªåŠ¨æ¸…ç†æœ€æ—©çš„å›¾ç‰‡ã€‚å½“å‰ä½¿ç”¨ï¼š<span id="currentUsage">-</span></small>
        </div>
        <div id="cacheProgress" class="cache-progress" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <span class="progress-text" id="progressText"></span>
        </div>
    </div>
</div>

<div id="message" class="message" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
  async function loadStats() {
    try {
      const response = await fetch("/admin/api/stats");
      if (response.status === 401) {
        window.location.href = "/admin/login";
        return;
      }
      const stats = await response.json();

      document.getElementById("localImages").textContent = stats.local_images;
      document.getElementById("diskUsage").textContent =
        stats.disk_usage_mb + " MB";
      document.getElementById("pendingUploads").textContent =
        stats.pending_uploads;
      document.getElementById("failedUploads").textContent =
        stats.failed_uploads;
    } catch (err) {
      console.error("åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:", err);
    }
  }

  async function loadSettings() {
    try {
      const response = await fetch("/admin/api/settings");
      if (response.ok) {
        const settings = await response.json();
        document.getElementById("cacheTtl").textContent =
          settings.local_cache_ttl_hours + " å°æ—¶";
        document.getElementById("metadataRetention").textContent =
          settings.metadata_retention_days + " å¤©";
        document.getElementById("r2Configured").textContent = settings.r2_bucket_name
          ? "æ˜¯ (" + settings.r2_bucket_name + ")"
          : "å¦";
        
        // Max cache size
        const maxMb = settings.max_local_cache_mb || 0;
        document.getElementById("maxCacheMb").value = maxMb;
      }
    } catch (err) {
      console.error("åŠ è½½è®¾ç½®å¤±è´¥:", err);
    }
  }

  async function updateCacheProgress() {
    try {
      const statsResp = await fetch("/admin/api/stats");
      const stats = await statsResp.json();
      
      const settingsResp = await fetch("/admin/api/settings");
      const settings = await settingsResp.json();
      
      const currentMb = stats.disk_usage_mb || 0;
      const maxMb = settings.max_local_cache_mb || 0;
      
      document.getElementById("currentUsage").textContent = currentMb + " MB";
      
      const progressDiv = document.getElementById("cacheProgress");
      if (maxMb > 0) {
        progressDiv.style.display = "block";
        const percent = Math.min(100, (currentMb / maxMb) * 100);
        document.getElementById("progressFill").style.width = percent + "%";
        document.getElementById("progressFill").className = 
          "progress-fill" + (percent > 80 ? " warning" : "") + (percent > 95 ? " danger" : "");
        document.getElementById("progressText").textContent = 
          `${currentMb} / ${maxMb} MB (${percent.toFixed(1)}%)`;
      } else {
        progressDiv.style.display = "none";
      }
    } catch (err) {
      console.error("æ›´æ–°ç¼“å­˜è¿›åº¦å¤±è´¥:", err);
    }
  }

  async function saveMaxCacheSize() {
    const maxMb = parseInt(document.getElementById("maxCacheMb").value) || 0;
    
    try {
      const response = await fetch("/admin/api/settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ max_local_cache_mb: maxMb })
      });
      
      if (response.ok) {
        showMessage("ç¼“å­˜å¤§å°é™åˆ¶å·²ä¿å­˜");
        updateCacheProgress();
      } else {
        showMessage("ä¿å­˜å¤±è´¥", true);
      }
    } catch (err) {
      showMessage("ä¿å­˜å¤±è´¥", true);
    }
  }

  async function triggerCleanup() {
    if (!confirm("è¿™å°†åˆ é™¤è¿‡æœŸçš„æœ¬åœ°ç¼“å­˜æ–‡ä»¶ã€‚ç¡®è®¤ç»§ç»­ï¼Ÿ")) {
      return;
    }

    try {
      const response = await fetch("/admin/api/cleanup", { method: "POST" });
      const data = await response.json();
      showMessage(data.message);
      loadStats();
      updateCacheProgress();
    } catch (err) {
      showMessage("æ¸…ç†å¤±è´¥", true);
    }
  }

  async function clearAllLocal() {
    if (!confirm("âš ï¸ è¿™å°†åˆ é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜çš„å›¾ç‰‡æ–‡ä»¶ï¼\n\nå¦‚æœå›¾ç‰‡å·²ä¸Šä¼ åˆ° R2ï¼Œå¯ä»¥ä» R2 æ¢å¤ã€‚\nç¡®è®¤ç»§ç»­ï¼Ÿ")) {
      return;
    }

    try {
      const response = await fetch("/admin/api/clear-all-local", { method: "POST" });
      const data = await response.json();
      showMessage(data.message, !data.success);
      loadStats();
      updateCacheProgress();
    } catch (err) {
      showMessage("æ¸…é™¤å¤±è´¥", true);
    }
  }

  async function retryUploads() {
    try {
      const response = await fetch("/admin/api/retry-uploads", {
        method: "POST",
      });
      const data = await response.json();
      showMessage(data.message);
      loadStats();
    } catch (err) {
      showMessage("é‡è¯•ä¸Šä¼ å¤±è´¥", true);
    }
  }

  async function uploadPending() {
    try {
      const response = await fetch("/admin/api/upload-pending", {
        method: "POST",
      });
      const data = await response.json();
      showMessage(data.message, !data.success);
      loadStats();
    } catch (err) {
      showMessage("ä¸Šä¼ å¤±è´¥", true);
    }
  }

  async function generateThumbnails() {
    if (!confirm("è¿™å°†ä¸ºæ‰€æœ‰ç¼ºå°‘ç¼©ç•¥å›¾çš„æœ¬åœ°å›¾ç‰‡ç”Ÿæˆç¼©ç•¥å›¾ã€‚\nå›¾ç‰‡è¾ƒå¤šæ—¶å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ")) {
      return;
    }
    
    try {
      showMessage("æ­£åœ¨ç”Ÿæˆç¼©ç•¥å›¾ï¼Œè¯·ç¨å€™...", false);
      const response = await fetch("/admin/api/generate-thumbnails", {
        method: "POST",
      });
      const data = await response.json();
      showMessage(data.message, !data.success);
    } catch (err) {
      showMessage("ç”Ÿæˆç¼©ç•¥å›¾å¤±è´¥", true);
    }
  }

  function showMessage(msg, isError = false) {
    const messageDiv = document.getElementById("message");
    messageDiv.textContent = msg;
    messageDiv.className = "message " + (isError ? "error" : "success");
    messageDiv.style.display = "block";
    setTimeout(() => (messageDiv.style.display = "none"), 5000);
  }

  loadStats();
  loadSettings();
  updateCacheProgress();
  setInterval(loadStats, 30000);
  setInterval(updateCacheProgress, 30000);
</script>

<style>
  .cache-progress {
    margin-top: 15px;
  }
  .progress-bar {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: #28a745;
    transition: width 0.3s;
  }
  .progress-fill.warning {
    background: #ffc107;
  }
  .progress-fill.danger {
    background: #dc3545;
  }
  .progress-text {
    display: block;
    text-align: center;
    margin-top: 5px;
    font-size: 12px;
    color: #666;
  }
</style>
{% endblock %}

