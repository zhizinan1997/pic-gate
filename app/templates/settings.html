{% extends "base.html" %}

{% block title %}è®¾ç½® - PicGate ç®¡ç†åå°{% endblock %}

{% block content %}
<div class="page-header">
    <h1>è®¾ç½®</h1>
    <p>é…ç½® PicGate ç»˜å›¾ç½‘å…³</p>
</div>

<form id="settingsForm">
    <!-- Upstream AI Configuration -->
    <div class="card">
        <div class="card-header">
            <h2>ğŸ¤– ä¸Šæ¸¸ AI API</h2>
            <p class="card-subtitle">é…ç½® AI å›¾ç‰‡ç”ŸæˆæœåŠ¡</p>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="upstream_api_base">API åŸºç¡€ URL</label>
                <input type="url" id="upstream_api_base" name="upstream_api_base" placeholder="https://api.openai.com/v1">
                <small>ä¸Šæ¸¸ AI API çš„åŸºç¡€åœ°å€ï¼ˆOpenAI å…¼å®¹æ ¼å¼ï¼‰</small>
            </div>
            
            <div class="form-group">
                <label for="upstream_api_key">API å¯†é’¥</label>
                <input type="password" id="upstream_api_key" name="upstream_api_key" placeholder="sk-...">
                <small>ä¸Šæ¸¸ API å¯†é’¥</small>
            </div>
            
            <div class="form-group">
                <label for="upstream_model_name">æ¨¡å‹åç§°</label>
                <input type="text" id="upstream_model_name" name="upstream_model_name" placeholder="dall-e-3">
                <small>ç”¨äºå›¾ç‰‡ç”Ÿæˆçš„æ¨¡å‹</small>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="testUpstream()">ğŸ”— æµ‹è¯•ä¸Šæ¸¸ API è¿æ¥</button>
                <span id="upstreamTestResult" class="test-result"></span>
            </div>
        </div>
    </div>

    <!-- Gateway Configuration -->
    <div class="card">
        <div class="card-header">
            <h2>ğŸŒ ç½‘å…³é…ç½®</h2>
            <p class="card-subtitle">OpenWebUI è¿æ¥æ­¤ç½‘å…³çš„è®¾ç½®</p>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="gateway_model_name">ç½‘å…³æ¨¡å‹åç§°</label>
                <input type="text" id="gateway_model_name" name="gateway_model_name" placeholder="picgate">
                <small>å¯¹å¤–æš´éœ²ç»™ OpenWebUI çš„æ¨¡å‹åç§°ï¼ˆæ˜¾ç¤ºåœ¨ /v1/modelsï¼‰</small>
            </div>
            
            <div class="form-group">
                <label for="gateway_api_key">ç½‘å…³ API å¯†é’¥</label>
                <div class="input-group">
                    <input type="text" id="gateway_api_key" name="gateway_api_key" placeholder="pg-...">
                    <button type="button" class="btn btn-secondary" onclick="generateKey()">ç”Ÿæˆ</button>
                </div>
                <small>OpenWebUI è¿æ¥æ­¤ç½‘å…³æ—¶ä½¿ç”¨çš„ API å¯†é’¥</small>
            </div>
        </div>
    </div>

    <!-- Public URL Configuration (CRITICAL) -->
    <div class="card card-important">
        <div class="card-header">
            <h2>ğŸ”— å…¬å¼€ URL é…ç½®</h2>
            <p class="card-subtitle">é‡è¦ï¼šæ§åˆ¶è¿”å›ç»™ OpenWebUI çš„å›¾ç‰‡ URL åŸŸå</p>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <strong>è¿™æ˜¯ä»€ä¹ˆï¼Ÿ</strong> è¿™æ˜¯ç½‘å…³çš„å…¬å¼€è®¿é—®åŸºå€ã€‚
                è¿”å›ç»™ OpenWebUI çš„æ‰€æœ‰å›¾ç‰‡ URL éƒ½å°†ä½¿ç”¨æ­¤åŸŸåã€‚
            </div>
            
            <div class="form-group">
                <label for="public_base_url">å…¬å¼€åŸºç¡€ URL</label>
                <input type="url" id="public_base_url" name="public_base_url" placeholder="https://img.example.com">
                <small>
                    <strong>ç¤ºä¾‹ï¼š</strong><br>
                    â€¢ åŒæœºè¿è¡Œï¼Œæ— åä»£ï¼š<code>http://æœåŠ¡å™¨IP:5643</code><br>
                    â€¢ ä½¿ç”¨åå‘ä»£ç†ï¼š<code>https://img.example.com</code><br>
                    â€¢ ç•™ç©ºåˆ™è‡ªåŠ¨ä»è¯·æ±‚å¤´æ¨æ–­
                </small>
            </div>
            
            <div class="alert alert-warning">
                <strong>åå‘ä»£ç†ç”¨æˆ·æ³¨æ„ï¼š</strong> å¦‚æœæ‚¨ä½¿ç”¨ nginx/Caddy ä»£ç†æ­¤ç½‘å…³ï¼Œ
                å¿…é¡»è®¾ç½®ä¸ºæ‚¨çš„å…¬å¼€åŸŸåï¼ˆå¦‚ <code>https://img.example.com</code>ï¼‰ã€‚
                å¦åˆ™å›¾ç‰‡ URL å¯èƒ½ä¸æ­£ç¡®ã€‚
            </div>
        </div>
    </div>

    <!-- R2 Storage Configuration -->
    <div class="card">
        <div class="card-header">
            <h2>â˜ï¸ Cloudflare R2 å­˜å‚¨</h2>
            <p class="card-subtitle">å¯é€‰çš„äº‘å­˜å‚¨ï¼Œç”¨äºå›¾ç‰‡é•¿æœŸå½’æ¡£</p>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="r2_account_id">è´¦æˆ· ID</label>
                <input type="text" id="r2_account_id" name="r2_account_id" placeholder="your-account-id">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="r2_access_key_id">Access Key ID</label>
                    <input type="text" id="r2_access_key_id" name="r2_access_key_id">
                </div>
                
                <div class="form-group">
                    <label for="r2_secret_access_key">Secret Access Key</label>
                    <input type="password" id="r2_secret_access_key" name="r2_secret_access_key">
                </div>
            </div>
            
            <div class="form-group">
                <label for="r2_bucket_name">å­˜å‚¨æ¡¶åç§°</label>
                <input type="text" id="r2_bucket_name" name="r2_bucket_name" placeholder="my-picgate-bucket">
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="testR2()">â˜ï¸ æµ‹è¯• R2 è¿æ¥</button>
                <span id="r2TestResult" class="test-result"></span>
            </div>
        </div>
    </div>

    <!-- Cache Configuration -->
    <div class="card">
        <div class="card-header">
            <h2>â° ç¼“å­˜é…ç½®</h2>
            <p class="card-subtitle">æœ¬åœ°ç¼“å­˜å’Œå…ƒæ•°æ®ä¿ç•™è®¾ç½®</p>
        </div>
        <div class="card-body">
            <div class="form-row">
                <div class="form-group">
                    <label for="local_cache_ttl_hours">æœ¬åœ°ç¼“å­˜ TTLï¼ˆå°æ—¶ï¼‰</label>
                    <select id="local_cache_ttl_hours" name="local_cache_ttl_hours">
                        <option value="24">24 å°æ—¶ï¼ˆ1 å¤©ï¼‰</option>
                        <option value="72">72 å°æ—¶ï¼ˆ3 å¤©ï¼‰</option>
                        <option value="168">168 å°æ—¶ï¼ˆ7 å¤©ï¼‰</option>
                        <option value="720">720 å°æ—¶ï¼ˆ30 å¤©ï¼‰</option>
                    </select>
                    <small>å›¾ç‰‡åœ¨æœ¬åœ°ç¼“å­˜ä¸­ä¿ç•™å¤šä¹…</small>
                </div>
                
                <div class="form-group">
                    <label for="metadata_retention_days">å…ƒæ•°æ®ä¿ç•™æœŸï¼ˆå¤©ï¼‰</label>
                    <input type="number" id="metadata_retention_days" name="metadata_retention_days" min="30" max="3650" value="365">
                    <small>å›¾ç‰‡å…ƒæ•°æ®åœ¨æ•°æ®åº“ä¸­ä¿ç•™å¤šä¹…</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Configuration -->
    <div class="card">
        <div class="card-header">
            <h2>ğŸ”’ å®‰å…¨è®¾ç½®</h2>
        </div>
        <div class="card-body">
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" id="allow_external_image_fetch" name="allow_external_image_fetch">
                    å…è®¸è·å–å¤–éƒ¨å›¾ç‰‡
                </label>
                <small>å¯ç”¨åï¼Œç½‘å…³å¯ä»¥ä»å¤–éƒ¨ URL ä¸‹è½½å›¾ç‰‡ã€‚å‡ºäºå®‰å…¨è€ƒè™‘å»ºè®®ç¦ç”¨ã€‚</small>
            </div>
            
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" id="delete_r2_on_metadata_expire" name="delete_r2_on_metadata_expire">
                    å…ƒæ•°æ®è¿‡æœŸæ—¶åˆ é™¤ R2 å¯¹è±¡
                </label>
                <small>å¯ç”¨åï¼Œå…ƒæ•°æ®è¿‡æœŸæ—¶ä¼šåŒæ—¶åˆ é™¤ R2 ä¸­çš„å¯¹è±¡ã€‚å¦åˆ™åªåˆ é™¤æœ¬åœ°å…ƒæ•°æ®ã€‚</small>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-lg">ä¿å­˜è®¾ç½®</button>
    </div>
</form>

<div id="message" class="message" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('settingsForm');
    const messageDiv = document.getElementById('message');

    async function loadSettings() {
        try {
            const response = await fetch('/admin/api/settings/full');
            if (response.status === 401) {
                window.location.href = '/admin/login';
                return;
            }
            const settings = await response.json();
            
            // Populate form fields
            document.getElementById('upstream_api_base').value = settings.upstream_api_base || '';
            document.getElementById('upstream_api_key').value = settings.upstream_api_key || '';
            document.getElementById('upstream_model_name').value = settings.upstream_model_name || '';
            document.getElementById('gateway_model_name').value = settings.gateway_model_name || '';
            document.getElementById('gateway_api_key').value = settings.gateway_api_key || '';
            document.getElementById('public_base_url').value = settings.public_base_url || '';
            document.getElementById('r2_account_id').value = settings.r2_account_id || '';
            document.getElementById('r2_access_key_id').value = settings.r2_access_key_id || '';
            document.getElementById('r2_secret_access_key').value = settings.r2_secret_access_key || '';
            document.getElementById('r2_bucket_name').value = settings.r2_bucket_name || '';
            document.getElementById('local_cache_ttl_hours').value = settings.local_cache_ttl_hours || 72;
            document.getElementById('metadata_retention_days').value = settings.metadata_retention_days || 365;
            document.getElementById('allow_external_image_fetch').checked = settings.allow_external_image_fetch || false;
            document.getElementById('delete_r2_on_metadata_expire').checked = settings.delete_r2_on_metadata_expire || false;
        } catch (err) {
            console.error('åŠ è½½è®¾ç½®å¤±è´¥:', err);
            showMessage('åŠ è½½è®¾ç½®å¤±è´¥', true);
        }
    }

    async function generateKey() {
        try {
            const response = await fetch('/admin/api/settings/generate-key', { method: 'POST' });
            const data = await response.json();
            document.getElementById('gateway_api_key').value = data.key;
        } catch (err) {
            console.error('ç”Ÿæˆå¯†é’¥å¤±è´¥:', err);
        }
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = {
            upstream_api_base: document.getElementById('upstream_api_base').value,
            upstream_api_key: document.getElementById('upstream_api_key').value,
            upstream_model_name: document.getElementById('upstream_model_name').value,
            gateway_model_name: document.getElementById('gateway_model_name').value,
            gateway_api_key: document.getElementById('gateway_api_key').value,
            public_base_url: document.getElementById('public_base_url').value,
            r2_account_id: document.getElementById('r2_account_id').value,
            r2_access_key_id: document.getElementById('r2_access_key_id').value,
            r2_secret_access_key: document.getElementById('r2_secret_access_key').value,
            r2_bucket_name: document.getElementById('r2_bucket_name').value,
            local_cache_ttl_hours: parseInt(document.getElementById('local_cache_ttl_hours').value),
            metadata_retention_days: parseInt(document.getElementById('metadata_retention_days').value),
            allow_external_image_fetch: document.getElementById('allow_external_image_fetch').checked,
            delete_r2_on_metadata_expire: document.getElementById('delete_r2_on_metadata_expire').checked,
        };

        try {
            const response = await fetch('/admin/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showMessage('è®¾ç½®å·²ä¿å­˜ï¼');
            } else {
                const error = await response.json();
                showMessage(error.detail || 'ä¿å­˜è®¾ç½®å¤±è´¥', true);
            }
        } catch (err) {
            showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ã€‚', true);
        }
    });

    function showMessage(msg, isError = false) {
        messageDiv.textContent = msg;
        messageDiv.className = 'message ' + (isError ? 'error' : 'success');
        messageDiv.style.display = 'block';
        setTimeout(() => messageDiv.style.display = 'none', 5000);
    }

    async function testUpstream() {
        const resultEl = document.getElementById('upstreamTestResult');
        resultEl.textContent = 'æµ‹è¯•ä¸­...';
        resultEl.className = 'test-result testing';
        
        try {
            const response = await fetch('/admin/api/settings/test-upstream', { method: 'POST' });
            const data = await response.json();
            
            resultEl.textContent = data.message;
            resultEl.className = 'test-result ' + (data.success ? 'success' : 'error');
        } catch (err) {
            resultEl.textContent = 'æµ‹è¯•å¤±è´¥';
            resultEl.className = 'test-result error';
        }
    }

    async function testR2() {
        const resultEl = document.getElementById('r2TestResult');
        resultEl.textContent = 'æµ‹è¯•ä¸­...';
        resultEl.className = 'test-result testing';
        
        try {
            const response = await fetch('/admin/api/settings/test-r2', { method: 'POST' });
            const data = await response.json();
            
            resultEl.textContent = data.message;
            resultEl.className = 'test-result ' + (data.success ? 'success' : 'error');
        } catch (err) {
            resultEl.textContent = 'æµ‹è¯•å¤±è´¥';
            resultEl.className = 'test-result error';
        }
    }

    // Auto-save functionality
    let autoSaveTimeout = null;
    const autoSaveDelay = 2000; // 2 seconds after last change

    function enableAutoSave() {
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('change', triggerAutoSave);
            input.addEventListener('input', triggerAutoSave);
        });
    }

    function triggerAutoSave() {
        // Clear previous timeout
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        
        // Show saving indicator
        showAutoSaveStatus('saving');
        
        // Set new timeout
        autoSaveTimeout = setTimeout(async () => {
            await saveSettings(true);
        }, autoSaveDelay);
    }

    async function saveSettings(isAutoSave = false) {
        const data = {
            upstream_api_base: document.getElementById('upstream_api_base').value,
            upstream_api_key: document.getElementById('upstream_api_key').value,
            upstream_model_name: document.getElementById('upstream_model_name').value,
            gateway_model_name: document.getElementById('gateway_model_name').value,
            gateway_api_key: document.getElementById('gateway_api_key').value,
            public_base_url: document.getElementById('public_base_url').value,
            r2_account_id: document.getElementById('r2_account_id').value,
            r2_access_key_id: document.getElementById('r2_access_key_id').value,
            r2_secret_access_key: document.getElementById('r2_secret_access_key').value,
            r2_bucket_name: document.getElementById('r2_bucket_name').value,
            local_cache_ttl_hours: parseInt(document.getElementById('local_cache_ttl_hours').value),
            metadata_retention_days: parseInt(document.getElementById('metadata_retention_days').value),
            allow_external_image_fetch: document.getElementById('allow_external_image_fetch').checked,
            delete_r2_on_metadata_expire: document.getElementById('delete_r2_on_metadata_expire').checked,
        };

        try {
            const response = await fetch('/admin/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                if (isAutoSave) {
                    showAutoSaveStatus('saved');
                } else {
                    showMessage('è®¾ç½®å·²ä¿å­˜ï¼');
                }
            } else {
                showAutoSaveStatus('error');
                if (!isAutoSave) {
                    const error = await response.json();
                    showMessage(error.detail || 'ä¿å­˜è®¾ç½®å¤±è´¥', true);
                }
            }
        } catch (err) {
            showAutoSaveStatus('error');
            if (!isAutoSave) {
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•ã€‚', true);
            }
        }
    }

    function showAutoSaveStatus(status) {
        let indicator = document.getElementById('autoSaveIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'autoSaveIndicator';
            indicator.className = 'auto-save-indicator';
            document.body.appendChild(indicator);
        }
        
        if (status === 'saving') {
            indicator.textContent = 'â³ æ­£åœ¨ä¿å­˜...';
            indicator.className = 'auto-save-indicator saving';
        } else if (status === 'saved') {
            indicator.textContent = 'âœ… å·²è‡ªåŠ¨ä¿å­˜';
            indicator.className = 'auto-save-indicator saved';
            setTimeout(() => indicator.className = 'auto-save-indicator hidden', 2000);
        } else if (status === 'error') {
            indicator.textContent = 'âŒ ä¿å­˜å¤±è´¥';
            indicator.className = 'auto-save-indicator error';
            setTimeout(() => indicator.className = 'auto-save-indicator hidden', 3000);
        }
    }

    loadSettings();
    enableAutoSave();
</script>

<style>
    .test-result {
        margin-left: 15px;
        font-size: 14px;
        padding: 5px 10px;
        border-radius: 4px;
    }
    .test-result.testing {
        color: #666;
    }
    .test-result.success {
        color: #155724;
        background: #d4edda;
    }
    .test-result.error {
        color: #721c24;
        background: #f8d7da;
    }
    .auto-save-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1000;
        transition: opacity 0.3s, transform 0.3s;
    }
    .auto-save-indicator.saving {
        background: #fff3cd;
        color: #856404;
    }
    .auto-save-indicator.saved {
        background: #d4edda;
        color: #155724;
    }
    .auto-save-indicator.error {
        background: #f8d7da;
        color: #721c24;
    }
    .auto-save-indicator.hidden {
        opacity: 0;
        transform: translateY(10px);
        pointer-events: none;
    }
</style>
{% endblock %}


